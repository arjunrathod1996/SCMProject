<!DOCTYPE html>
<html lang="en"  xmlns:th="http://www.thymeleaf.org" th:fragment="parent(content,title,script)">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Viewport meta tag -->

<head>
    <title data-th-text="${user.getEmail()}">Profile Page</title>
 

    <!-- Bootstrap Datepicker CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
    
    

    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.min.css">

    <!-- DataTables Bootstrap 4 Integration CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.3/css/dataTables.bootstrap4.min.css">
    

    <!-- DataTables Select CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/select/1.3.3/css/select.dataTables.min.css">
    
    <!-- Common CSS -->
   <link rel="stylesheet" th:href="@{/css/common.css}">
   <!-- Font Awesome -->
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <link
    href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
    rel="stylesheet">
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
    
    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/css/custom.css}">
    <link rel="stylesheet" th:href="@{/css/sidebar.scss}">
    <link rel="stylesheet" th:href="@{/css/min.css}">
    <link rel="stylesheet" th:href="@{/css/admin2.css}">
    
    <!-- Bootstrap CSS Working dont remove -->
    <!--<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" 
    		integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">-->
    		
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.17/dist/css/bootstrap-select.min.css">
    
	 <!-- Bootstrap Select Picker CSS -->
	<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.14.0-beta2/css/bootstrap-select.min.css" rel="stylesheet">
	
	<style>
		.hidden {
			display: none;
		}
		
		/* Styling for different elements in the table */
.lead-name {
    font-weight: bold;
    color: #007bff;
}

.first-name, .designation, .phone-number, .note, .creation-time {
    color: #6c757d;
}

.email-link {
    color: #17a2b8;
    text-decoration: none;
}

.email-link:hover {
    text-decoration: underline;
}

.hidden {
    display: none;
}

/* Optional: Table row styling for better readability */
.table tr {
    transition: background-color 0.3s;
}

.table tr:hover {
    background-color: #f8f9fa;
}

	</style>
	
</head>

<body>

    <div th:replace="~{user/user_sidebar :: user_sidebar}" ></div>

   <div id="responsiveContainerAlert" >
        <div  id="status_alert_content"  class="alert hidden alert-warning container text-center"  role="alert">
        </div>
   </div>
      
    <!-- <div id="content"> -->
        <div  class="container small_screen" id="responsiveContainer" >
            <!-- Page Heading -->
            <div class="d-sm-flex align-items-center justify-content-between mb-4" >
                <h1 class="h3 mb-0 text-gray-800 text-primary">Contacts</h1>
            </div>
            <!-- ./Page Heading -->
            <!-- Horizonatal Line -->
            <hr class="mt-0 mb-4">
            <!-- ./Horizonatal Line -->
            <!-- Search Data -->                
            <div class="d-flex flex-wrap align-items-center mb-4 small" >
                <div class="form-group mb-2" style="width: 150px; margin-left: 5px; padding: 0;">
                    <div id="date_picker_start" class="input-group date">
                        <input id="start_date" class="form-control input-sm" type="text"
                            placeholder="Start Date"
                            th:value="${param.startDate != null} ? ${param.startDate[0]}"
                            style="font-size: 12px;" />
                        <span class="input-group-addon">
                            <span class="fa fa-calendar"></span>
                        </span>
                    </div>
                </div>
                <div class="form-group mb-2" style="width: 150px; margin-left: 5px; padding: 0;">
                    <div id="date_picker_end" class="input-group date">
                        <input id="end_date" class="form-control input-sm" type="text"
                            placeholder="End Date"
                            th:value="${param.endDate != null} ? ${param.endDate[0]}"
                            style="font-size: 12px;" />
                        <span class="input-group-addon">
                            <span class="fa fa-calendar"></span>
                        </span>
                    </div>
                </div>
                <div class="form-group mb-2" style="width: 150px; margin-left: 5px; padding: 0;">
                    <input id="leadID" class="form-control input-sm " type="text" placeholder="lead ID"
						th:value="${param.leadID != null} ? ${param.leadID[0]}" style="font-size: 12px" />
                </div>
                <div class="form-group mb-2" style="width: 150px; margin-left: 5px; padding: 0;">
                   <input id="leadName" class="form-control input-sm " type="text" placeholder="lead Name"
					 th:value="${param.leadName != null} ? ${param.leadName[0]}" style="font-size: 12px" />
                </div>
                <div class="form-group mb-2" style="width: 150px; margin-left: 5px; padding: 0;">
                   <input id="name" class="form-control input-sm " type="text" placeholder="Contact Name"
						th:value="${param.name != null} ? ${param.name[0]}" style="font-size: 12px" />
                </div>
                <div class="form-group mb-2" style="width: 150px; margin-left: 5px; padding: 0;">
                 	<input id="designation" class="form-control input-sm " type="text" placeholder="Designation"
						th:value="${param.designation != null} ? ${param.designation[0]}" style="font-size: 12px" />
                </div>
                 <div class="form-group mb-2" style="width: 150px; margin-left: 5px; padding: 0;">
                 	<input id="email" class="form-control input-sm " type="text" placeholder="Email"
						th:value="${param.email != null} ? ${param.email[0]}" style="font-size: 12px" />
                </div>
                <div class="form-group mb-2" style="width: 150px; margin-left: 5px; padding: 0;">
                 	<input id="phoneNumber" class="form-control input-sm " type="text" placeholder="Phone Number"
						th:value="${param.phoneNumber != null} ? ${param.phoneNumber[0]}" style="font-size: 12px" />
                </div>
                <div class="form-group mb-2" style="width: 150px; margin-left: 5px; padding: 0;">
                   <input id="filter_important" type="checkbox"
						th:checked="${param.important != null} ? ${param.important[0]}"> Important
                </div>
                <div class="form-group mb-2" style="margin-left: 5px; padding: 0;">
                    <button type="button" class="btn btn-default btn-sm square-border-radius" onclick="filter()">
                        <i class="fa fa-search" aria-hidden="true"></i>
                    </button>
                </div>
            </div>
            <!-- ./Search Data -->
            <!-- Buttons -->
            <div class="d-sm-flex align-items-center justify-content-end mb-4 small">
                <div class="btn-group btn-group-sm">
                    <button data-toggle="modal" onclick="showCreateForm()" class="btn btn-default btn-sm" title="Create Leads" style="border: 1px solid #ccc; border-radius: 5px;">
                        <i class="fa fa-plus"></i>
                    </button>
                    <button data-toggle="modal" onclick="showEditForm()" class="btn btn-default btn-sm ml-2" title="Edit Leads" style="border: 1px solid #ccc; border-radius: 5px;">
                        <i class="fa fa-pencil"></i>
                    </button>
                    <button data-toggle="modal" onclick="deleteData()" class="btn btn-default btn-sm ml-2" title="Delete Leads" style="border: 1px solid #ccc; border-radius: 5px;">
                        <i class="fa fa-trash"></i>
                    </button>
                </div>
            </div>
            <!-- ./Buttons -->
            <!-- Table -->
            <div class=" d-flex flex-wrap align-items-center mb-4 small">
                <!-- Card Header - Dropdown -->
                <div class="card-header py-2 d-flex " style="margin-bottom: 10px;">
                    <h6 class="m-0 font-weight-bold text-primary">Contact Table</h6>
                </div>
                <!-- Card Body -->
                <div class="table-responsive" style="overflow-x: auto;">
                    <table id="leadContactsTable" class="table table-striped table-hover small" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th></th>
								<th>Lead</th>
								<th>Name</th>
								<th>Designation</th>
								<th>Phone</th>
								<th>Email</th>
								<th>Note</th>
								<th>Time</th>
                            </tr>
                        </thead>
                    </table>
                </div>   
            </div>
            <!-- Modal -->
            <div id="leadContacModal" class="modal fade "  tabindex="-1" role="dialog" aria-labelledby="leadContacModalLabel" aria-hidden="true" style="margin-top: 70px;">
                <div class="modal-dialog" role="document" style="max-width: 500px;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="leadContacModalLabel"><span id="header_modal">Create </span>Contacts</h5>
                            <input type="hidden" id="leads_code_id">
							<input type="hidden" id="contactId">
                            <button onclick="closeModal()" type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form id="business_form">
                                <div class="row">
                                    <div class="col-lg-12" >
                                        <div class="form-group">
											<label class="control-label">Lead</label>
											<div>
												<input id = "lead_name" autocomplete="off" class="form-control input-sm" type="text" placeholder="Lead Name">
												<input id="lead_id" type="hidden" class="form-control">
												<small class="help-block">Type first 3 Characters to Seach Lead Name</small>
											</div>
										</div>
                                    </div>
                                </div>
                                <div class="row">
								<div class="col-lg-6">
									<div class="form-group">
										<label class="control-label">First Name</label>
										<input type="text" id="first_name" class="form-control input-sm" name="first_name">
									</div>
								</div>
								<div class="col-lg-6" id="count_of_code_id">
									<div class="form-group">
										<label class="control-label">Last Name</label>
										<input type="text" id="last_name" class="form-control input-sm" name="last_name">
									</div>
								</div>
							</div>
							<div class="row">
								<div class="col-lg-6">
									<div class="form-group">
										<label class="control-label">Designation</label>
										<input type="text" id="designation_" class="form-control input-sm" name="designation">
									</div>
								</div>
								<div class="col-lg-6">
									<div class="form-group">
										<label class="control-label">Location</label>
										<input type="text" id="location" class="form-control input-sm" name="location">
									</div>
								</div>
							</div>
							<div class="row">
								<div class="col-lg-6">
									<div class="form-group">
										<label class="control-label">Phone Number</label>
										<input type="text" id="phone_number" class="form-control input-sm" name="phone_number">
									</div>
								</div>
								<div class="col-lg-6">
									<div class="form-group">
										<label class="control-label">Phone Number (Alternate)</label>
										<input type="text" id="phone_number2" class="form-control input-sm" name="phone_number2">
									</div>
								</div>
							</div>
							<div class="row" id="follow-up-input-row">
								<div class="col-lg-6">
									<div class="form-group">
										<label class="control-label">Email</label>
										<input type="text" id="email_" class="form-control input-sm" name="email">
									</div>
								</div>
								<div class="col-lg-6">
									<div class="form-group">
										<label class="control-label">Profile Link (e.g. LinkedIn)</label>
										<input type="text" id="profile_link" class="form-control input-sm" name="profile_link">
									</div>
								</div>
							</div>
							<div class="row" id="lead_comment_section">
								<div class="col-lg-12">
									<div class="form-group">
										<label class="control-label">Note</label>
										<input type="text" id="note" class="form-control input-sm" name="note">
									</div>
								</div>
							</div>
							<div class="row " id="lead_comment_section">
								<div class="col-lg-12">
									<div class="form-group">
										<input type="checkbox" id="important" > Important Contact
									</div>
								</div>
							</div>
                            <!--./row-->
                            <div class="row mb-5" >
                                <div class="col-lg-12">
                                    <div class="form-group text-right">
                                        <button type="button" class="btn btn-sm btn-default" onclick="closeModal()">Close</button>&nbsp;
                                        <button id="btn_submit" type="button" class="btn btn-sm btn-primary" onClick="save()">Save</button>
                                    </div>	
                                    <div id="message_status" class="alert alert-info text-center hidden"></div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
<!-- jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<!-- Popper.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.11.6/umd/popper.min.js"></script>

<!-- Bootstrap Bundle JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.1/js/bootstrap.bundle.min.js"></script>

<!-- Bootstrap Select Picker JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.14.0-beta2/js/bootstrap-select.min.js"></script>

<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>

<!-- DataTables Select JS -->
<script src="https://cdn.datatables.net/select/1.3.3/js/dataTables.select.min.js"></script>

<!-- Bootstrap Datepicker CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.10.0/css/bootstrap-datepicker.min.css">

<!-- Bootstrap Datepicker JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.10.0/js/bootstrap-datepicker.min.js"></script>

<!-- Bootstrap JS -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-3-typeahead/4.0.2/bootstrap3-typeahead.min.js" integrity="sha512-HWlJyU4ut5HkEj0QsK/IxBCY55n5ZpskyjVlAoV9Z7XQwwkqXoYdCIC93/htL3Gu5H3R4an/S0h2NXfbZk3g7w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<!-- Your custom scripts -->
<script src="/js/script.js"></script> 
<script src="/js/side.js"></script>
<script src="/js/admin2.js"></script>
<script src="/js/admin2_min.js"></script>

<script type="text/javascript">
	
	
var mLeadInput= $('#lead_name');
	
mLeadInput.change(function(){
	var current = mLeadInput.typeahead("getActive");
	if(current){
		if(current.name == mLeadInput.val()){
			$('#lead_id').val(current.id);
		}else{
			$('#lead_id').val("");
		}
	}
});

var leadQuery = function(query,process){
	statusAlertWidget('#activity_save_status','alert-progress',null);
	$.get('/api/leads/search?name=' + query,
		function(data){
		statusAlertWidget('#activity_save_status',null,null);
				return process(data);
	}).fail(function(){
		statusAlertWidget('#activity_save_status','alert-danger','Failed read lead');
	});
};

$(document).ready(function () {		
	mLeadInput.typeahead({
	source : leadQuery,
	minLength : 1,
	items : 'all',
	});		
	var table = setupContactsTable();
	setupDatePicker();
});

function setupDatePicker(){
	var datePickerOptions = {
        format: 'yyyy-mm-dd',
        autoclose: true
    };
    $('#date_picker_start').datepicker(datePickerOptions);
    $('#date_picker_end').datepicker(datePickerOptions);
};

function showCreateForm(){
	$('#header_modal').html('Create');
	$('#leadContacModal').modal('show');
};

function showEditForm(){	
	var row = readTableData('#leadContactsTable');
	if(row.length == 0 ){
		statusAlert('alert-danger','No Lead Contact Selected');
		return;
	}
	id = row[0];
	console.log('row id : ' + id);
	$.get('/api/leads/contacts?id=' + id).done(
		function(data,textStatus,jqXHR){
		statusAlert(null,null);
		showEditor(data);
	}).fail(function(error){
		statusAlert('alert-danger','Failed to read Lead Contact');
	});
};

function showEditor(data){
	$('#header_modal').html('Edit');	
	$('#first_name').val(data['firstName']);
	$('#last_name').val(data['lastName']);
	$('#designation_').val(data['designation']);
	$('#location').val(data['location']);
	$('#phone_number').val(data['phoneNumber']);
	$('#phone_number2').val(data['phoneNumber2']);
	$('#email_').val(data['email']);
	$('#note').val(data['note']);
	$('#important').prop('checked',data['important']);
	var extras = data['contactExtras'];
	if(extras){
		if(extras['profileLink'])
			$('#profile_link').val(extras['profileLink']);
	}
	setSelectedLead(data['leadMain']);
	$('#leadContacModal').modal('show');
};

function setSelectedLead(lead){
	if(!lead)
		return;
		
	$('#lead_name').val(lead['name']);
	$('#lead_id').val(lead['id']);
	$('#lead_name').prop('readonly',true);
};

function save(){
			
	$('#lead_name').closest('.form-group').removeClass('has-error');
	$('#first_name').closest('.form-group').removeClass('has-error');
	$('#phone_name').closest('.form-group').removeClass('has-error');
	
	if(!$('#lead_id').val()){
		$('#lead_name').closest('.form-group').addClass('has-error');
		return false;
	}
	
	if(!$('#first_name').val()){
		$('#first_name').closest('.form-group').addClass('has-error');
		return false;
	}
	
	statusAlertWidget('#contact_status','alert-progress',null);
	
	var row = readTableData('#leadContactsTable');
	var important = $('#important').prop('checked');
	
	var id = row[0];
	var leadID = $('#lead_id').val();
	var url = '/api/leads/contacts?leadID=' + leadID;
	var parms = '';
	
	if(id)
		parms += '&id=' + id;
		
	url += parms;
	
	console.log('url : ' + url);
	
	var contact = {
		'firstName'        : $('#first_name').val(),
		'lastName'         : $('#last_name').val(),
		'designation'      : $('#designation_').val(),
		'location'         : $('#location').val(),
		'phoneNumber'      : $('#phone_number').val(),
		'phoneNumber2'     : $('#phone_number2').val(),
		'email'            : $('#email_').val(),
		'note'             : $('#note').val(),
		'important'        : important,
	};
	
	contact['contactExtras'] = {
		'profileLink' : $('#profile_link').val() ? $('#profile_link').val() : undefined,
	}
	
	console.log('data',JSON.stringify(contact));
	
	$.ajax({
		headers : {
			'Content-Type' : 'application/json'
		},
		data    : JSON.stringify(contact),
		timeout : 60000,
		type    : 'POST',
		url     : url,
		beforeSend : function(){
			com_disableClick('btn_submit');
		},
	}).done(function(data,textStatus,jqXHR){
		statusAlertWidget('#message_status', 'alert alert-success', 'Successfully Submitted...');
	}).fail(function(jqXHR,textStatus,errorThrown){
		if(jqXHR && jqXHR.responseText)
			statusAlertWidget('#message_status', 'alert alert-danger', 'Failed : ' + jqXHR.responseText);
		else
			statusAlertWidget('#message_status', 'alert alert-danger', 'Failed to Save');
	})
	
}

function setupContactsTable() {
	var url = '/api/leads/contacts/page_list';
	var parm = undefined;
	if (location.href.indexOf('?') > 0) {

		parm = location.href.substring(location.href.indexOf('?'), location.href.length);
		url += parm;

	}

	var name = "leadContactsTable";
	var columns = setUpColumns();

	var columnDefs = [{
		orderable: false,
		className: 'select-checkbox',
		targets: 0,

	},

	{
		orderable: true,
		targets: [0],
		orderSequence: ["desc", "asc",]

	}];

	var select = {

		style: 'os',
		selector: 'td:first-child'

	};

	var orderIndex = columns.length - 1;

	tableInit(name, columns, [0, "desc"], columnDefs, select, url);

}

function setUpColumns() {

    console.log("table render");
    var columns = [];
    columns.push({
        "data": "id",
        "defaultContent": "",
        "render": function (data, type, row) {
            return "<input class='hidden' value='" + data + "'>";
        },
        "orderable": false
    });

    columns.push({
        "data": "leadMain.name",
        "render": function (data, type, row) {
            if (data != null) {
                return "<span class='lead-name'>" + data + "</span>";
            } else {
                return '';
            }
        }
    });

    columns.push({
        "data": "firstName",
        "render": function (data, type, row) {
            if (data != null) {
                return "<span class='first-name'>" + data + "</span>";
            } else {
                return '';
            }
        }
    });

    columns.push({
        "data": "designation",
        "render": function (data, type, row) {
            if (data != null) {
                return "<span class='designation'>" + data + "</span>";
            } else {
                return '';
            }
        }
    });

    columns.push({
        "data": "phoneNumber",
        "render": function (data, type, row) {
            if (data != null) {
                return "<span class='phone-number'>" + data + "</span>";
            } else {
                return '';
            }
        }
    });

    columns.push({
        "data": "email",
        "render": function (data, type, row) {
            if (data != null) {
                return "<a href='mailto:" + data + "' class='email-link'>" + data + "</a>";
            } else {
                return '';
            }
        }
    });

    columns.push({
        "data": "note",
        "render": function (data, type, row) {
            if (data != null) {
                return "<span class='note'>" + data + "</span>";
            } else {
                return '';
            }
        }
    });

    columns.push({
        "data": "creationTime",
        "render": function (data, type, row) {
            if (data != null) {
                var date = new Date(data);
                return "<span class='creation-time'>" + date.toLocaleDateString() + " " + date.toLocaleTimeString() + "</span>";
            } else {
                return '';
            }
        }
    });

    console.log("columns values :  " + JSON.stringify(columns));
    return columns;
}

	
function filter(){
			
	params = "";
	var url = '/user/dashboard/leads/conatcts';
	
	var filterFields = [
		
						['#start_date','startDate'],['#end_date','endDate'],
						['#leadID','leadID'],['#leadName','leadName'],
						['#name','name'],['#designation','designation'],['#email','email'],['#phoneNumber','phoneNumber']
					    ]
					    
	if($('#filter_important').length > 0 && $('#filter_important').prop('checked')){
		url += '?important=true'
	}
	
	com_invokeUrlWithParms(url,filterFields,'leadContactsTable');
}


function closeModal() {
    location.reload();
}


</script>
</body>
</html>