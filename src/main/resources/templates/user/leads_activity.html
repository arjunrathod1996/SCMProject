<!DOCTYPE html>
<html lang="en"  xmlns:th="http://www.thymeleaf.org" th:fragment="parent(content,title,script)">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Viewport meta tag -->

<head>
    <title data-th-text="${user.getEmail()}">Profile Page</title>
 

    <!-- Bootstrap Datepicker CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
    
    

    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.min.css">

    <!-- DataTables Bootstrap 4 Integration CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.3/css/dataTables.bootstrap4.min.css">
    

    <!-- DataTables Select CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/select/1.3.3/css/select.dataTables.min.css">
    
    <!-- Common CSS -->
   <link rel="stylesheet" th:href="@{/css/common.css}">
   <!-- Font Awesome -->
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <link
    href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
    rel="stylesheet">
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
    
    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/css/custom.css}">
    <link rel="stylesheet" th:href="@{/css/sidebar.scss}">
    <link rel="stylesheet" th:href="@{/css/min.css}">
    <link rel="stylesheet" th:href="@{/css/admin2.css}">
    
    <!-- Bootstrap CSS Working dont remove -->
    <!--<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" 
    		integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">-->
    		
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.17/dist/css/bootstrap-select.min.css">
    
	 <!-- Bootstrap Select Picker CSS -->
	<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.14.0-beta2/css/bootstrap-select.min.css" rel="stylesheet">
	
	<style>
		.hidden {
			display: none;
		}
		
		/* Styling for different elements in the table */
.hidden {
    display: none;
}

.lead-name {
    font-weight: bold;
    color: #007bff;
}

.contact-name {
    font-weight: bold;
    color: #6c757d;
}

.badge {
    display: inline-block;
    padding: 0.35em 0.65em;
    font-size: 75%;
    font-weight: 700;
    line-height: 1;
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
    border-radius: 0.375rem;
    transition: all 0.3s ease;
}

.badge-info {
    background-color: #17a2b8;
}

.badge-primary {
    background-color: #007bff;
}

.badge-warning {
    background-color: #ffc107;
}

.badge-success {
    background-color: #28a745;
}

.badge-danger {
    background-color: #dc3545;
}

.badge-default {
    background-color: lightgreen;
}

.label {
    font-size: 90%;
    padding: 0.2em 0.4em;
    border-radius: 0.25rem;
    transition: all 0.3s ease;
}

.label-primary {
    background-color: #007bff;
    color: #fff;
}

.label-warning {
    background-color: #ffc107;
    color: #fff;
}

.animated {
    animation-duration: 0.3s;
    animation-fill-mode: both;
}

.fadeIn {
    animation-name: fadeIn;
}

@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

/* Optional: Table row styling for better readability */
.table tr {
    transition: background-color 0.3s;
}

.table tr:hover {
    background-color: #f8f9fa;
}

	</style>
	
</head>

<body>

    <div th:replace="~{user/user_sidebar :: user_sidebar}" ></div>

   <div id="responsiveContainerAlert" >
        <div  id="status_alert_content"  class="alert hidden alert-warning container text-center"  role="alert">
        </div>
   </div>
      
    <!-- <div id="content"> -->
        <div  class="container small_screen" id="responsiveContainer" >
            <!-- Page Heading -->
            <div class="d-sm-flex align-items-center justify-content-between mb-4" >
                <h1 class="h3 mb-0 text-gray-800 text-primary">Activity</h1>
            </div>
            <!-- ./Page Heading -->
            <!-- Horizonatal Line -->
            <hr class="mt-0 mb-4">
            <!-- ./Horizonatal Line -->
            <!-- Search Data -->                
            <div class="d-flex flex-wrap align-items-center mb-4 small" >
                <div class="form-group mb-2" style="width: 150px; margin-left: 5px; padding: 0;">
                    <div id="date_picker_start" class="input-group date">
                        <input id="start_date" class="form-control input-sm" type="text"
                            placeholder="Start Date"
                            th:value="${param.startDate != null} ? ${param.startDate[0]}"
                            style="font-size: 12px;" />
                        <span class="input-group-addon">
                            <span class="fa fa-calendar"></span>
                        </span>
                    </div>
                </div>
                <div class="form-group mb-2" style="width: 150px; margin-left: 5px; padding: 0;">
                    <div id="date_picker_end" class="input-group date">
                        <input id="end_date" class="form-control input-sm" type="text"
                            placeholder="End Date"
                            th:value="${param.endDate != null} ? ${param.endDate[0]}"
                            style="font-size: 12px;" />
                        <span class="input-group-addon">
                            <span class="fa fa-calendar"></span>
                        </span>
                    </div>
                </div>
               <!-- <div class="form-group mb-2" style="width: 150px; margin-left: 5px; padding: 0;">
                    <select class="form-control input-sm" id = "filter_status" style="height: 33px;">
						<option value="">Status : All</option>
						<option th:each="type : ${T(com.SCM.leads.LeadMain.LeadActivity.ActivityType).values()}" 
							th:text = "${type.getTag()}"
								th:value = "${type}"
								th:selected="${param.activityType != null && param.activityType[0].equals(type.name())} ">
						</option>
					</select>
                </div>-->
                <div class="form-group mb-2" style="width: 150px; margin-left: 5px; padding: 0;">
                   <input id="leadID" class="form-control input-sm " type="text" placeholder="leadID"
						th:value="${param.leadID != null} ? ${param.leadID[0]}" style="font-size: 12px" />
                </div>
                <div class="form-group mb-2" style="width: 150px; margin-left: 5px; padding: 0;">
                   <input id="leadName" class="form-control input-sm " type="text" placeholder="lead Name"
						th:value="${param.leadName != null} ? ${param.leadName[0]}" style="font-size: 12px" />
                </div>
                <div class="form-group mb-2" style="margin-left: 5px; padding: 0;">
                    <button type="button" class="btn btn-default btn-sm square-border-radius" onclick="filter()">
                        <i class="fa fa-search" aria-hidden="true"></i>
                    </button>
                </div>
            </div>
            <!-- ./Search Data -->
            <!-- Buttons -->
            <div class="d-sm-flex align-items-center justify-content-end mb-4 small">
                <div class="btn-group btn-group-sm">
                    <button data-toggle="modal" onclick="showCreateForm()" class="btn btn-default btn-sm" title="Create Leads" style="border: 1px solid #ccc; border-radius: 5px;">
                        <i class="fa fa-plus"></i>
                    </button>
                    <button data-toggle="modal" onclick="showEditForm()" class="btn btn-default btn-sm ml-2" title="Edit Leads" style="border: 1px solid #ccc; border-radius: 5px;">
                        <i class="fa fa-pencil"></i>
                    </button>
                    <button data-toggle="modal" onclick="deleteData()" class="btn btn-default btn-sm ml-2" title="Delete Leads" style="border: 1px solid #ccc; border-radius: 5px;">
                        <i class="fa fa-trash"></i>
                    </button>
                </div>
            </div>
            <!-- ./Buttons -->
            <!-- Table -->
            <div class=" d-flex flex-wrap align-items-center mb-4 small">
                <!-- Card Header - Dropdown -->
                <div class="card-header py-2 d-flex " style="margin-bottom: 10px;">
                    <h6 class="m-0 font-weight-bold text-primary">Activity Table</h6>
                </div>
                <!-- Card Body -->
                <div class="table-responsive" style="overflow-x: auto;">
                    <table id="activityTable" class="table table-striped table-hover small" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th></th>
								<th>Lead</th>
								<th>Contact</th>
								<th>Activity</th>
								<th>Message</th>
								<th>Time</th>
                            </tr>
                        </thead>
                    </table>
                </div>   
            </div>
            <!-- Modal -->
            <div id="modalLeadActivity" class="modal fade "  tabindex="-1" role="dialog" aria-labelledby="modalLeadActivityLabel" aria-hidden="true" style="margin-top: 70px;">
                <div class="modal-dialog" role="document" style="max-width: 500px;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="modalLeadActivityLabel"><span id="header_modal">Create </span> Task</h5>
                            <input type="hidden" id="leads_code_id">
							<input type="hidden" id="contactId">
                            <button onclick="closeModal()" type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form id="business_form">
                                <div class="row">
                                    <div class="col-lg-12" >
                                        <div class="form-group">
											<label class="control-label">Lead</label>
											<div>
												<input id = "lead_name" autocomplete="off" class="form-control input-sm" type="text" placeholder="Lead Name">
												<input id="lead_id" type="hidden" class="form-control">
												<small class="help-block">Type first 3 Characters to Seach Lead Name</small>
											</div>
										</div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-lg-12" >
                                        <div class="form-group">
											<label class="control-label">Contact</label>
											<div>
												<input id = "contact_name" autocomplete="off" class="form-control input-sm" type="text" placeholder="Contact Name">
												<input id="contact_id" type="hidden" class="form-control">
												<small class="help-block">Type first 3 Characters to Seach Contact Name</small>
											</div>
										</div>
                                    </div>
                                </div>
                                <div class="row">
								<div class="col-lg-6">
									<div class="form-group">
										<label class="control-label">Type</label>
										<select id="activity_type" class="form-control input-sm">
											<option value="TASK">Task</option>
											<option value="TASK_CALL">Call</option>
											<option value="TASK_EMAIL">Email</option>
											<option value="TASK_MEETING">Meeting</option>
										</select>
										<small class="help-block">Select Performed Task</small>
									</div>
								</div>
								<div class="col-lg-6" id="count_of_code_id">
									<div class="form-group">
										<label class="control-label">Status</label>
										<select id="activity_status" class="form-control input-sm">
											<option value="">Select Status</option>
											<option th:each="status : ${T(com.SCM.leads.LeadActivity.ActivityStatis).values()}"
												th:text = "${status}" th:value = "${status}">
											</option>
										</select>
									</div>
								</div>
							</div>
							<div class="row">
								<div class="col-lg-6">
									<div class="form-group">
										<label class="control-label">Message</label>
										<input id="message" type="text" class="form-control input-sm" maxlength="100" placeholder="Briefly explain task task or any comment..."  >
									</div>
								</div>
							</div>
							<hr>
                            <!--./row-->
                            <div class="row mb-5" >
                                <div class="col-lg-12">
                                    <div class="form-group text-right">
                                        <button type="button" class="btn btn-sm btn-default" onclick="closeModal()">Close</button>&nbsp;
                                        <button id="btn_submit" type="button" class="btn btn-sm btn-primary" onClick="save()">Save</button>
                                    </div>	
                                    <div id="message_status" class="alert alert-info text-center hidden"></div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
<!-- jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<!-- Popper.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.11.6/umd/popper.min.js"></script>

<!-- Bootstrap Bundle JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.1/js/bootstrap.bundle.min.js"></script>

<!-- Bootstrap Select Picker JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.14.0-beta2/js/bootstrap-select.min.js"></script>

<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>

<!-- DataTables Select JS -->
<script src="https://cdn.datatables.net/select/1.3.3/js/dataTables.select.min.js"></script>

<!-- Bootstrap Datepicker CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.10.0/css/bootstrap-datepicker.min.css">

<!-- Bootstrap Datepicker JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.10.0/js/bootstrap-datepicker.min.js"></script>

<!-- Bootstrap JS -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-3-typeahead/4.0.2/bootstrap3-typeahead.min.js" integrity="sha512-HWlJyU4ut5HkEj0QsK/IxBCY55n5ZpskyjVlAoV9Z7XQwwkqXoYdCIC93/htL3Gu5H3R4an/S0h2NXfbZk3g7w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<!-- Your custom scripts -->
<script src="/js/script.js"></script> 
<script src="/js/side.js"></script>
<script src="/js/admin2.js"></script>
<script src="/js/admin2_min.js"></script>

<script type="text/javascript">
	
	
var mLeadInput= $('#lead_name');
	
mLeadInput.change(function(){
	var current = mLeadInput.typeahead("getActive");
	if(current){
		if(current.name == mLeadInput.val()){
			$('#lead_id').val(current.id);
		}else{
			$('#lead_id').val("");
		}
	}
});

var leadQuery = function(query,process){
	statusAlertWidget('#activity_save_status','alert-progress',null);
	$.get('/api/leads/search?name=' + query,
		function(data){
		statusAlertWidget('#activity_save_status',null,null);
				return process(data);
	}).fail(function(){
		statusAlertWidget('#activity_save_status','alert-danger','Failed read lead');
	});
};

var mContactInput = $('#contact_name');

mContactInput.change(function(){
	var current = mContactInput.typeahead("getActive");
	if(current){
		if(current.name == mContactInput.val()){
			$('#contact_id').val(current.id);
		}else{
			$('#contact_id').val("");
		}
	}
});

var contactQuery = function(query,process){
	var leadID = $('#lead_id').val();
	if(!leadID)
		statusAlertWidget('#activity_save_status','alert-danger', 'No Lead Selected');
	
	var url = '/api/leads/contacts/search?leadId=' + leadID;
	url += '&name='+query;
	$.get(url,function(data){
		statusAlertWidget('#activity_save_status', null, null);
		//Append locality to distinguish Branch name
		if(data.length > 0){
			for(i = 0 ; i <data.length; i++){
				data[i]['name'] = getContactTitle(data[i]);
			}
		}
		return process(data);
	}).fail(function(){
		statusAlertWidget('#activity_save_status','alert-danger', 'Failed to lead');
	});
}

$(document).ready(function () {		
	setupDatePicker();
	mLeadInput.typeahead({
	source : leadQuery,
	minLength : 1,
	items : 'all',
	});
	mContactInput.typeahead({
	source : contactQuery,
	minLength : 1,
	items : 'all',
	});
	setupActivityTable();
});

function setupDatePicker(){
	var datePickerOptions = {
        format: 'yyyy-mm-dd',
        autoclose: true
    };
    $('#date_picker_start').datepicker(datePickerOptions);
    $('#date_picker_end').datepicker(datePickerOptions);
};

function showCreateForm(){
	$('#header_modal').html('Create');
	$('#modalLeadActivity').modal('show');
};

function showEditForm(){	
	var row = readTableData('#leadsActivityTable');
	if(row.length == 0){
		statusAlert('alert-danger','No Activity Selected');
		return;
	}
	id = row[0];
	console.log('row id : ' + id);
	
	$.get('/api/leads/activities/task?id=' + id).done(
		function(data,textStatus,jqXHR){
			statusAlert(null,null);
			showEditor(data);
		}).fail(function(data,textStatus,jqXHR){
			statusAlert('alert-danger','Failed to lead Activity');
	});
};

function showEditor(data){
			
	if(!data){
		statusAlert('alert-danger','Can not change this Activity');
		return;
	}	
	$('#header_modal').html('Edit');
	$('#activity_type').val(data['activityType']);
	$('#activity_status').val(data['activityStatus'])
	$('#message').val(data['message']);
	$('#activity_type').prop('disabled',true);
	setSelectedLead(data['leadMain']);
	setSelectedContact(data['contact']);
	$('#modalLeadActivity').modal('show');
};

function getContactTitle(contact){
	if(!contact)
		return;
	var title = contact['firstName'];
	if(contact['designation'])
		title += '('+contact['designation'] +')';
	return title;
}

function setSelectedLead(lead){
	if(!lead)
		return;
		
	$('#lead_name').val(lead['name']);
	$('#lead_id').val(lead['id']);
	$('#lead_name').prop('readonly',true);
}

function setSelectedContact(contact){
	if(!contact)
		return;
		
	$('#contact_name').val(getContactTitle(contact));
	$('#contact_id').val(contact['id']);
	$('#contact_name').prop('readonly',true);
}

function save(){
	
	$('#lead_name').closest('.form-group').removeClass('has-error');
	
	if(!$('#lead_id').val()){
		$('#lead_name').closest('.form-group').addClass('has-error');
		return false;
	}
	
	statusAlertWidget('#activity_save_status', 'alert-progress', null);
	
	var row = readTableData('#leadActivityTable');
	var id = row[0];
	var leadID = $('#lead_id').val();
	var contactID = $('#contact_id').val();
	var url = '/api/leads/activities/task?leadID=' + leadID;
	
	console.log('contactID',contactID);
	console.log('leadID',leadID);
	
	var parms = '';
	
	if(id)
		parms += '&id='+id;
		
	if(contactID)
		parms += '&contactID=' + contactID;
	
	url += parms;
	
	console.log("url",url);	
		
	var activity = {
		'activityType'      : $('#activity_type').val(),
		'activityStatus'    : $('#activity_status').val() ? $('#activity_status').val() : undefined,
		'message'           : $('#message').val(),
		//'contact'           : contactID ? makeResUrl('/api/leads/contacts/',contactID):undefined,
		//'contact'           : contactID,
	};
	
	console.log('dataa', JSON.stringify(activity));
	
	$.ajax({
		headers : {
			'Content-Type' : 'application/json'
		},
		data    : JSON.stringify(activity),
		timeout : 60000,
		type    : 'POST',
		url     : url,
		beforeSend : function(){
			com_disableClick('btn_submit');
		},
	}).done(function(data,textStatus,jqXHR){
		statusAlertWidget('#message_status', 'alert alert-success', 'Successfully Save Activity...');
	}).fail(function(jqXHR,textStatus,errorThrown){
		if(jqXHR && jqXHR.responseText)
			statusAlertWidget('#message_status', 'alert alert-danger', 'Failed : ' + jqXHR.responseText);
		else
			statusAlertWidget('#message_status', 'alert alert-danger', 'Failed to Save');
	})
	
}

function setupActivityTable() {
	
	
	var url = '/api/leads/activities/page_list';

	var parm = undefined;

	if (location.href.indexOf('?') > 0) {

		parm = location.href.substring(location.href.indexOf('?'), location.href.length);
		url += parm;

	}

	var name = "activityTable";

	var columns = setUpColumns();

	var columnDefs = [{
		orderable: false,
		className: 'select-checkbox',
		targets: 0,

	},

	{
		orderable: true,
		targets: [0],
		orderSequence: ["desc", "asc",]

	}];

	var select = {

		style: 'os',
		selector: 'td:first-child'

	};

	var orderIndex = columns.length - 1;

	tableInit(name, columns, [0, "desc"], columnDefs, select, url);

}
	
function setUpColumns() {
    console.log("table render");
    var columns = [];
    columns.push({
        "data": "id",
        "defaultContent": "",
        "render": function (data, type, row) {
            return "<input class='hidden' value='" + data + "'>";
        },
        "orderable": false
    });

    columns.push({
        "data": "leadMain.name",
        "render": function (data, type, row) {
            var leadName = row.leadMain.name;
            var statusBadge = "<span class='badge badge-info small animated fadeIn'>" + row.leadMain.status + "</span>";
            return "<span class='lead-name'>" + leadName + "</span><br>" + statusBadge;
        }
    });

    columns.push({
        "data": "contact",
        "render": function (data, type, row) {
            if (!data) return '';
            
            var content = "<span class='contact-name'>" + data.firstName + "</span>";
            if (data.designation) {
                content += "<div><span class='badge badge-info small animated fadeIn'>" + data.designation + "</span></div>";
            }
            return content;
        }
    });

    columns.push({
        "data": "activityType",
        "render": function (data, type, row) {
            var labelClass = 'label-primary';
            if (data === 'ASSIGNED' || data === 'STATUS_CHANGED') labelClass = 'label-warning';
            
            var content = "<span class='label " + labelClass + " animated fadeIn'>" + data + "</span>";
            if (row.activityStatus) {
                var badgeClass = 'badge badge-default';
                if (row.activityStatus === 'Complete') badgeClass = 'badge badge-success';
                if (row.activityStatus === 'Cancel') badgeClass = 'badge badge-danger';
                
                content += "&nbsp;&nbsp;<span class='small " + badgeClass + " animated fadeIn'>" + row.activityStatus + "</span>";
            }
            return content;
        }
    });

    columns.push({
        "data": "message",
        "render": function (data, type, row) {
            return "<span class='message animated fadeIn'>" + data + "</span>";
        }
    });

    columns.push({
        "data": "creationTime",
        "render": function (data, type, row) {
            return "<span class='creation-time animated fadeIn'>" + data + "</span>";
        }
    });

    console.log("columns values :  " + JSON.stringify(columns));
    return columns;
}

	
function filter(){
			
	params = "";
	var url = '/user/dashboard/leads/activity';
	
	var filterFields = [
		
						['#start_date','startDate'],['#end_date','endDate'],
						['#leadID','leadID'],['#leadName','leadName'],
						['#filter_activity','activityType'],
					    ]
	
	com_invokeUrlWithParms(url,filterFields,'activityTable');
}


function closeModal() {
    location.reload();
}


</script>
</body>
</html>